name: Weekly Translation Workflow

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install deep-translator
    
    - name: Create translation directories
      run: |
        mkdir -p en tw kr jp
    
    - name: Create translation script
      run: |
        cat > translate.py << 'EOF'
        #!/usr/bin/env python3
        # -*- coding: utf-8 -*-
        from deep_translator import GoogleTranslator
        import re
        import os
        import sys
        
        def is_chinese(text):
            return bool(re.search(r'[\u4e00-\u9fff]', text))
        
        def translate_text(text, target_lang):
            if not text or not text.strip() or not is_chinese(text):
                return text
            try:
                # è¿‡æ»¤æŽ‰ä»…ç”±ç¬¦å·ç»„æˆçš„æ–‡æœ¬
                if not re.search(r'[a-zA-Z\u4e00-\u9fff]', text):
                    return text
                return GoogleTranslator(source='zh-CN', target=target_lang).translate(text)
            except Exception as e:
                print(f"\nTranslation error: {e}")
                return text
        
        def process_content_with_vars(content, target_lang):
            """
            ä¿æŠ¤ ${var} å’Œ $var ä¸è¢«ç¿»è¯‘
            """
            # åŒ¹é… ${var} æˆ– $var (ç®€å•å˜é‡å)
            parts = re.split(r'(\$\{?\w+\}?)', content)
            translated_parts = [
                translate_text(p, target_lang) if is_chinese(p) else p
                for p in parts
            ]
            return ''.join(translated_parts)

        def translate_line(line, target_lang):
            stripped = line.strip()
            if not is_chinese(stripped):
                return line

            # 1. å¤„ç†æ³¨é‡Š (# å¼€å¤´)
            if stripped.startswith('#'):
                comment_part = line.split('#', 1)
                return comment_part[0] + '#' + translate_text(comment_part[1], target_lang) + '\n'

            # 2. å¤„ç†åŒ…å«å¼•å·çš„å†…å®¹ (é€‚ç”¨äºŽå˜é‡èµ‹å€¼ local var="..." æˆ– echo "...")
            # è¿™ä¸ªæ­£åˆ™ä¼šå¯»æ‰¾æ‰€æœ‰è¢«å•å¼•å·æˆ–åŒå¼•å·åŒ…è£¹çš„éƒ¨åˆ†
            def quote_replacer(match):
                quote = match.group(1) # ' æˆ– "
                content = match.group(2)
                return f"{quote}{process_content_with_vars(content, target_lang)}{quote}"

            # åŒ¹é… '...' æˆ– "..."
            new_line = re.sub(r'([\'"])(.*?)\1', quote_replacer, line)
            return new_line
        
        def translate_file(input_file, output_file, target_lang):
            print(f"Translating to {target_lang}...")
            if not os.path.exists(input_file): return False
            
            with open(input_file, 'r', encoding='utf-8') as f:
                lines = f.readlines()
            
            with open(output_file, 'w', encoding='utf-8') as f_out:
                for i, line in enumerate(lines):
                    # ç›´æŽ¥å¤„ç†æ¯ä¸€è¡Œï¼Œtranslate_line å†…éƒ¨ä¼šåˆ¤æ–­æ˜¯å¦æœ‰ä¸­æ–‡
                    f_out.write(translate_line(line, target_lang))
            
            print(f"Done: {target_lang}")
            return True
        
        if __name__ == "__main__":
            input_file = 'kejilion.sh'
            languages = {'en': 'en', 'tw': 'zh-TW', 'kr': 'ko', 'jp': 'ja'}
            success_count = 0
            for dir_name, lang_code in languages.items():
                if translate_file(input_file, f'{dir_name}/kejilion.sh', lang_code):
                    success_count += 1
            if success_count == 0: sys.exit(1)
        EOF
    
    - name: Run translation
      run: python translate.py
    
    - name: Check for changes
      id: check_changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "ðŸŒ Weekly translation update - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create summary
      if: always()
      run: |
        echo "## Translation Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        for dir in en tw kr jp; do
          [ -f "$dir/kejilion.sh" ] && status="âœ… Success" || status="âŒ Failed"
          echo "| $dir | $status |" >> $GITHUB_STEP_SUMMARY
        done
