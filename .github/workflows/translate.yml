name: Weekly Translation Workflow

on:
  schedule:
    # æ¯å‘¨æ—¥ UTC 02:00 æ‰§è¡Œ (åŒ—äº¬æ—¶é—´å‘¨æ—¥ 10:00)
    - cron: '0 2 * * 0'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install deep-translator
    
    - name: Create translation directories
      run: |
        mkdir -p en tw kr jp
    
    - name: Create translation script
      run: |
        cat > translate.py << 'EOF'
        #!/usr/bin/env python3
        # -*- coding: utf-8 -*-
        from deep_translator import GoogleTranslator
        import re
        import os
        import sys
        
        def is_chinese(text):
            return bool(re.search(r'[\u4e00-\u9fff]', text))
        
        def translate_text(text, target_lang):
            if not text.strip() or not is_chinese(text):
                return text
            try:
                return GoogleTranslator(source='zh-CN', target=target_lang).translate(text)
            except Exception as e:
                print(f"\nTranslation error: {e}")
                return text
        
        def translate_line_preserving_variables(line, target_lang):
            """
            å¤„ç† echo/read/send_stats ç­‰å‘½ä»¤ä¸­çš„ä¸­æ–‡ï¼ŒåŒæ—¶ä¿æŠ¤å…¶ä¸­çš„ ${var}
            """
            def repl(match):
                full_string = match.group(0)
                quote = full_string[0]
                content = full_string[1:-1]
                # åˆ†å‰²å‡ºå˜é‡ï¼Œåªç¿»è¯‘éžå˜é‡éƒ¨åˆ†
                parts = re.split(r'(\$\{?\w+\}?)', content)
                translated_parts = [
                    translate_text(p, target_lang) if is_chinese(p) else p
                    for p in parts
                ]
                return quote + ''.join(translated_parts) + quote
            
            return re.sub(r'(?:\'[^\']*\'|"[^"]*")', repl, line)

        def translate_assignment_value(line, target_lang):
            """
            ä¸“é—¨å¤„ç†å˜é‡èµ‹å€¼è¯­å¥ï¼šVAR="ä¸­æ–‡å†…å®¹" -> VAR="Translated Content"
            """
            # åŒ¹é… key="value" æˆ– key='value' æ ¼å¼ï¼Œä¸” value åŒ…å«ä¸­æ–‡
            match = re.match(r'^(\s*[a-zA-Z_][a-zA-Z0-9_]*\s*=\s*)([\'"])(.*)([\'"])(.*)$', line)
            if match:
                prefix, quote_open, value, quote_close, suffix = match.groups()
                if is_chinese(value):
                    # åŒæ ·è¦ä¿æŠ¤èµ‹å€¼å†…å®¹é‡Œçš„ ${var}
                    parts = re.split(r'(\$\{?\w+\}?)', value)
                    translated_value = "".join([
                        translate_text(p, target_lang) if is_chinese(p) else p 
                        for p in parts
                    ])
                    return f"{prefix}{quote_open}{translated_value}{quote_close}{suffix}\n"
            return line
        
        def translate_file(input_file, output_file, target_lang):
            print(f"Translating to {target_lang}...")
            
            if not os.path.exists(input_file):
                print(f"Error: Input file {input_file} not found")
                return False
            
            with open(input_file, 'r', encoding='utf-8') as f:
                lines = f.readlines()
            
            total_lines = len(lines)
            
            with open(output_file, 'w', encoding='utf-8') as f_out:
                for i, line in enumerate(lines):
                    progress = (i + 1) / total_lines * 100
                    print(f"\rProcessing: {progress:.1f}% ({i+1}/{total_lines})", end='')
                    
                    leading_space = re.match(r'^(\s*)', line).group(1)
                    stripped = line.strip()
                    
                    # 1. å¤„ç†æ³¨é‡Š
                    if stripped.startswith('#') and is_chinese(stripped):
                        comment_text = stripped[1:].strip()
                        if comment_text:
                            translated = translate_text(comment_text, target_lang)
                            f_out.write(f"{leading_space}# {translated}\n")
                        else:
                            f_out.write(line)
                    
                    # 2. å¤„ç†å¸¸ç”¨äº¤äº’å‘½ä»¤
                    elif any(cmd in stripped for cmd in ['echo', 'read', 'send_stats']) and is_chinese(stripped):
                        f_out.write(translate_line_preserving_variables(line, target_lang))
                    
                    # 3. å¤„ç†å˜é‡èµ‹å€¼ä¸­çš„ä¸­æ–‡ (æ–°å¢žå¼ºåŒ–)
                    elif '=' in stripped and is_chinese(stripped):
                        f_out.write(translate_assignment_value(line, target_lang))
                    
                    # 4. å…¶ä»–è¡ŒåŽŸæ ·ä¿ç•™
                    else:
                        f_out.write(line)
            
            print(f"\nTranslation to {target_lang} completed.")
            return True
        
        if __name__ == "__main__":
            input_file = 'kejilion.sh'
            languages = {'en': 'en', 'tw': 'zh-TW', 'kr': 'ko', 'jp': 'ja'}
            
            success_count = 0
            for dir_name, lang_code in languages.items():
                output_file = f'{dir_name}/kejilion.sh'
                if translate_file(input_file, output_file, lang_code):
                    success_count += 1
                    print(f"âœ“ {dir_name} done")
                print("-" * 30)
            
            if success_count == 0: sys.exit(1)
        EOF
    
    - name: Run translation
      run: python translate.py
    
    - name: Check for changes
      id: check_changes
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "ðŸŒ Weekly translation update - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create summary
      if: always()
      run: |
        echo "## Translation Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| Language | Directory | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        for dir in en tw kr jp; do
          if [ -f "$dir/kejilion.sh" ]; then
            echo "| $dir | /$dir/ | âœ… Success |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| $dir | /$dir/ | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
          fi
        done
