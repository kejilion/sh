name: Weekly Translation Workflow

on:
  schedule:
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  translate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install deep-translator
    
    - name: Create translation directories
      run: |
        mkdir -p en tw kr jp
    
    - name: Create translation script
      run: |
        cat > translate.py << 'EOF'
        #!/usr/bin/env python3
        # -*- coding: utf-8 -*-
        from deep_translator import GoogleTranslator
        import re
        import os
        import sys
        
        def is_chinese(text):
            return bool(re.search(r'[\u4e00-\u9fff]', text))
        
        def translate_text(text, target_lang):
            if not text.strip() or not is_chinese(text):
                return text
            try:
                # è¿‡æ»¤æŽ‰ä¸€äº›ä¸è¯¥ç¿»è¯‘çš„ç‰¹æ®Šç¬¦å·
                clean_text = text.strip()
                result = GoogleTranslator(source='zh-CN', target=target_lang).translate(clean_text)
                return result
            except Exception as e:
                print(f"\n[Error] {e}")
                return text

        def process_content_with_vars(content, target_lang):
            """
            æ ¸å¿ƒé€»è¾‘ï¼šä¿æŠ¤ ${var} å’Œ $varï¼Œç¿»è¯‘å…¶ä¸­çš„ä¸­æ–‡éƒ¨åˆ†
            """
            # åŒ¹é… ${var} æˆ– $var (å­—æ¯æ•°å­—ä¸‹åˆ’çº¿)
            parts = re.split(r'(\$\{\w+\}|\$\w+)', content)
            translated_parts = []
            for p in parts:
                if p.startswith('$'): # å˜é‡éƒ¨åˆ†ï¼Œä¿æŒåŽŸæ ·
                    translated_parts.append(p)
                elif is_chinese(p): # ä¸­æ–‡éƒ¨åˆ†ï¼Œç¿»è¯‘
                    translated_parts.append(translate_text(p, target_lang))
                else: # å…¶ä»–è‹±æ–‡/ç¬¦å·ï¼Œä¿æŒåŽŸæ ·
                    translated_parts.append(p)
            return "".join(translated_parts)

        def universal_translator(line, target_lang):
            """
            é€šç”¨ç¿»è¯‘å¼•æ“Žï¼šè¯†åˆ«è¡Œå†…æ‰€æœ‰å¼•å·å†…å®¹å¹¶ç¿»è¯‘
            """
            # 1. ä¿æŠ¤æ³¨é‡Šè¡Œ
            leading_space = re.match(r'^(\s*)', line).group(1)
            stripped = line.strip()
            if stripped.startswith('#'):
                comment_content = stripped[1:].strip()
                if is_chinese(comment_content):
                    return f"{leading_space}# {translate_text(comment_content, target_lang)}\n"
                return line

            # 2. è¯†åˆ«æ‰€æœ‰å¼•å·å†…çš„å†…å®¹ (åŒå¼•å·æˆ–å•å¼•å·)
            # ä½¿ç”¨æ­£åˆ™åŒ¹é…å¼•å·å¯¹ï¼ŒåŒæ—¶å¤„ç†è½¬ä¹‰å¼•å· \"
            def replacer(match):
                quote_type = match.group(1) # ' æˆ– "
                content = match.group(2)    # å¼•å·å†…çš„æ–‡æœ¬å†…å®¹
                if is_chinese(content):
                    # ç¿»è¯‘å†…å®¹ï¼Œä½†ä¿æŠ¤é‡Œé¢çš„å˜é‡
                    translated = process_content_with_vars(content, target_lang)
                    return f"{quote_type}{translated}{quote_type}"
                return match.group(0)

            # åŒ¹é… "content" æˆ– 'content'
            new_line = re.sub(r'([\'"])(.*?)(?<!\\)\1', replacer, line)
            return new_line
        
        def translate_file(input_file, output_file, target_lang):
            print(f"Translating to {target_lang}...")
            if not os.path.exists(input_file): return False
            
            with open(input_file, 'r', encoding='utf-8') as f:
                lines = f.readlines()
            
            total = len(lines)
            with open(output_file, 'w', encoding='utf-8') as f_out:
                for i, line in enumerate(lines):
                    if (i + 1) % 10 == 0 or i + 1 == total:
                        print(f"\rProgress: {(i+1)/total*100:.1f}%", end='')
                    
                    # åªè¦è¡Œå†…æœ‰ä¸­æ–‡ï¼Œå°±å°è¯•ç”¨é€šç”¨å¼•æ“Žç¿»è¯‘
                    if is_chinese(line):
                        f_out.write(universal_translator(line, target_lang))
                    else:
                        f_out.write(line)
            print(f"\n{target_lang} Success.")
            return True
        
        if __name__ == "__main__":
            input_file = 'kejilion.sh'
            langs = {'en': 'en', 'tw': 'zh-TW', 'kr': 'ko', 'jp': 'ja'}
            for dir_name, lang_code in langs.items():
                translate_file(input_file, f'{dir_name}/kejilion.sh', lang_code)
        EOF
    
    - name: Run translation
      run: python translate.py
    
    - name: Check for changes
      id: check_changes
      run: |
        git add .
        git diff --staged --quiet || echo "has_changes=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "ðŸŒ Weekly translation update - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create summary
      if: always()
      run: |
        echo "## Translation Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
        echo "| Language | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        for dir in en tw kr jp; do
          [ -f "$dir/kejilion.sh" ] && status="âœ… Success" || status="âŒ Failed"
          echo "| $dir | $status |" >> $GITHUB_STEP_SUMMARY
        done
